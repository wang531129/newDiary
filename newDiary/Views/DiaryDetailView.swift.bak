import SwiftUI
import SwiftData
import AppKit

// 添加扩展到文件顶级范围
extension NSTextView {
    func inFocus() -> Bool {
        self.window?.firstResponder == self
    }
}

// 添加自定義的TabView樣式
struct CustomTabStyle: View {
    let isSelected: Bool
    let color: Color
    let label: () -> AnyView
    
    init(isSelected: Bool, color: Color, @ViewBuilder label: @escaping () -> some View) {
        self.isSelected = isSelected
        self.color = color
        self.label = { AnyView(label()) }
    }
    
    var body: some View {
        VStack(spacing: 2) {
            label()
                .foregroundColor(isSelected ? .white : .primary)
                .padding(.horizontal, 6)
                .padding(.vertical, 4)
                .background(isSelected ? color : Color.clear)
                .cornerRadius(6)
            
            Rectangle()
                .fill(isSelected ? color : Color.clear)
                .frame(height: 2)
        }
    }
}

/// 日記詳細內容視圖
public struct DiaryDetailView: View {
    @Bindable var diary: DiaryEntry
    @Binding var selectedTab: String?
    
    @Environment(\.modelContext) private var modelContext
    @State private var showingSheet = false
    @State private var currentCategory: DiaryEntryType = .expense
    @State private var editingEntry: CategoryEntry? = nil
    @State private var selectedWeather: String
    @State private var isOnline = true
    @State private var isLoading = false
    @State private var thoughts: String
    
    // 警告相關狀態
    @State private var alertTitle = ""
    @State private var alertMessage = ""
    @State private var showingAlert = false
    
    // 提醒相关状态
    @State private var showingReminderDialog = false
    @State private var reminderDate = Date()
    @State private var reminderTime = Date()
    @State private var reminderTitle = ""
    @State private var selectedRepeatType: ReminderRepeatType = .none
    
    // 修改狀態變量
    @State private var showingQuickMenu = false
    @State private var lastAtPosition: Int = 0
    @FocusState private var isTextEditorFocused: Bool
    
    // 使用者偏好設置
    @AppStorage("titleFontSize") private var titleFontSize: Double = 22
    @AppStorage("contentFontSize") private var contentFontSize: Double = 16
    @AppStorage("titleFontColor") private var titleFontColor: String = "Green"
    @AppStorage("contentFontColor") private var contentFontColor: String = "White"
    @AppStorage("weatherApiKey") private var weatherApiKey: String = ""
    
    // 天氣服務
    private let weatherService: WeatherService?
    
    // 當前日期是今天嗎？
    private var isToday: Bool {
        Calendar.current.isDateInToday(diary.date)
    }
    
    // 標籤相關
    @State private var showingTagMenu = false
    
    // 標籤分類结构
    enum TagCategory: String, CaseIterable {
        case emotions = "情緒"
        case activities = "活動"
        case lifeAreas = "生活領域"
        case thinking = "思考"
        case time = "時間"
        case importance = "重要性"
        case events = "特殊事件"
        case health = "健康"
        
        var tags: [DiaryTag] {
            switch self {
            case .emotions:
                return [
                    DiaryTag(emoji: "😄", name: "開心"),
                    DiaryTag(emoji: "😔", name: "憂鬱"),
                    DiaryTag(emoji: "😰", name: "焦慮"),
                    DiaryTag(emoji: "😌", name: "滿足"),
                    DiaryTag(emoji: "🤩", name: "期待")
                ]
            case .activities:
                return [
                    DiaryTag(emoji: "💼", name: "工作"),
                    DiaryTag(emoji: "📚", name: "學習"),
                    DiaryTag(emoji: "🏃", name: "運動"),
                    DiaryTag(emoji: "🎮", name: "休閒"),
                    DiaryTag(emoji: "👥", name: "社交")
                ]
            case .lifeAreas:
                return [
                    DiaryTag(emoji: "🏠", name: "家庭"),
                    DiaryTag(emoji: "🏥", name: "健康"),
                    DiaryTag(emoji: "💰", name: "財務"),
                    DiaryTag(emoji: "❤️", name: "愛情"),
                    DiaryTag(emoji: "🤝", name: "友誼")
                ]
            case .thinking:
                return [
                    DiaryTag(emoji: "💭", name: "感悟"),
                    DiaryTag(emoji: "🎯", name: "目標"),
                    DiaryTag(emoji: "📝", name: "計劃"),
                    DiaryTag(emoji: "🔄", name: "回顧"),
                    DiaryTag(emoji: "❓", name: "疑問")
                ]
            case .time:
                return [
                    DiaryTag(emoji: "🌅", name: "早晨"),
                    DiaryTag(emoji: "☀️", name: "中午"),
                    DiaryTag(emoji: "🌆", name: "傍晚"),
                    DiaryTag(emoji: "🌙", name: "夜晚"),
                    DiaryTag(emoji: "📅", name: "週末")
                ]
            case .importance:
                return [
                    DiaryTag(emoji: "⭐", name: "重要"),
                    DiaryTag(emoji: "⚠️", name: "緊急"),
                    DiaryTag(emoji: "✏️", name: "隨筆"),
                    DiaryTag(emoji: "📌", name: "備忘"),
                    DiaryTag(emoji: "💡", name: "靈感")
                ]
            case .events:
                return [
                    DiaryTag(emoji: "🎂", name: "紀念"),
                    DiaryTag(emoji: "✈️", name: "旅行"),
                    DiaryTag(emoji: "🎉", name: "節日"),
                    DiaryTag(emoji: "🏆", name: "里程碑"),
                    DiaryTag(emoji: "😲", name: "意外")
                ]
            case .health:
                return [
                    DiaryTag(emoji: "🍲", name: "飲食"),
                    DiaryTag(emoji: "😴", name: "睡眠"),
                    DiaryTag(emoji: "💪", name: "運動"),
                    DiaryTag(emoji: "🤒", name: "症狀"),
                    DiaryTag(emoji: "🧠", name: "心理")
                ]
            }
        }
    }
    
    // 標籤數據結構
    struct DiaryTag: Identifiable {
        let id = UUID()
        let emoji: String
        let name: String
        
        var formatted: String {
            return "\(emoji)\(name): "
        }
    }
    
    // 所有標籤（由各分類整合）
    var allTags: [DiaryTag] {
        TagCategory.allCases.flatMap { $0.tags }
    }
    
    // 初始化方法
    public init(diary: DiaryEntry, selectedTab: Binding<String?>) {
        self._diary = Bindable(wrappedValue: diary)
        self._selectedTab = selectedTab
        self._selectedWeather = State(initialValue: diary.weather.rawValue)
        self._thoughts = State(initialValue: diary.thoughts)
        
        // 對於非今天的日期，自動設置為手動模式
        let isDateToday = Calendar.current.isDateInToday(diary.date)
        self._isOnline = State(initialValue: isDateToday)
        
        // 初始化天氣服務，如果API密鑰存在的話
        if let apiKey = UserDefaults.standard.string(forKey: "weatherApiKey"), !apiKey.isEmpty {
            self.weatherService = WeatherService(apiKey: apiKey)
        } else {
            self.weatherService = nil
        }
    }
    
    // 插入標籤到文本
    private func insertTag(_ tag: DiaryTag) {
        // 在当前文本末尾添加新行和标签
        thoughts += "\n\(tag.formatted)"
        diary.thoughts = thoughts
        saveContext()
    }
    
    // 添加待办事项
    private func addTodoItem() {
        // 获取当前文本和光标位置
        guard let textView = NSApplication.shared.keyWindow?.firstResponder as? NSTextView else {
            // 如果获取不到光标位置，就在末尾添加
            let newTodo = "🔳 "
            thoughts += thoughts.isEmpty ? newTodo : "\n\(newTodo)"
            diary.thoughts = thoughts
            saveContext()
            return
        }
        
        let selectedRange = textView.selectedRange()
        let text = thoughts as NSString
        
        // 获取光标所在行的范围
        let lineRange = text.lineRange(for: NSRange(location: selectedRange.location, length: 0))
        let line = text.substring(with: lineRange)
        
        // 准备新的文本
        var newText: String
        var cursorAdjustment = 0
        
        if line.hasPrefix("🔳") {
            // 如果已经有🔳，切换为✅，保留后面的内容
            let remainingText = String(line.dropFirst(1))  // 只删除表情符号
            newText = "✅\(remainingText)"
        } else if line.hasPrefix("✅") {
            // 如果已经有✅，切换为🔳，保留后面的内容
            let remainingText = String(line.dropFirst(1))  // 只删除表情符号
            newText = "🔳\(remainingText)"
        } else {
            // 如果没有标记，在行首添加🔳，保留整行内容
            newText = "🔳 \(line)"
            cursorAdjustment = 2  // 调整光标位置以适应新添加的"🔳 "
        }
        
        // 保存当前光标位置相对于行首的偏移量
        let cursorOffsetInLine = selectedRange.location - lineRange.location
        
        // 替换当前行
        let newRange = NSRange(location: lineRange.location, length: lineRange.length)
        textView.shouldChangeText(in: newRange, replacementString: newText)
        textView.replaceCharacters(in: newRange, with: newText)
        
        // 更新thoughts并保存
        thoughts = textView.string
        diary.thoughts = thoughts
        saveContext()
        
        // 设置新的光标位置
        let newCursorLocation = lineRange.location + cursorOffsetInLine + cursorAdjustment
        textView.setSelectedRange(NSRange(location: newCursorLocation, length: 0))
    }
    
    // 检查是否是待办事项
    private func isTodoItem(_ text: String) -> Bool {
        return text.hasPrefix("🔳 ") || text.hasPrefix("✅ ")
    }
    
    // 获取所有行
    private var lines: [String] {
        thoughts.components(separatedBy: .newlines)
    }
    
    // 記事部分的視圖
    private var thoughtsEditor: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text("記事")
                    .font(.system(size: titleFontSize))
                    .foregroundColor(Color.fromString(titleFontColor))
                    .fontWeight(.bold)
                
                Button(action: { showReminderDialog() }) {
                    Text("⏰")
                        .font(.system(size: titleFontSize))
                        .foregroundColor(Color.fromString(titleFontColor))
                }
                .buttonStyle(.borderless)
                .help("新增日期和時間提醒")
                .sheet(isPresented: $showingReminderDialog) {
                    ReminderDialog(
                        isPresented: $showingReminderDialog,
                        date: $reminderDate,
                        time: $reminderTime,
                        title: $reminderTitle,
                        onConfirm: addReminder
                    )
                }
                
                // 添加標籤按鈕
                Menu {
                    ForEach(TagCategory.allCases, id: \.self) { category in
                        Section(header: Text(category.rawValue)) {
                            ForEach(category.tags) { tag in
                                Button(action: { insertTag(tag) }) {
                                    Text("\(tag.emoji) \(tag.name)")
                                        .frame(maxWidth: .infinity, alignment: .leading)
                                }
                            }
                        }
                    }
                } label: {
                    HStack {
                        Text("🏷️")
                            .font(.system(size: titleFontSize))
                            .foregroundColor(Color.fromString(titleFontColor))
                        Text("標籤")
                            .font(.system(size: titleFontSize * 0.7))
                            .foregroundColor(Color.fromString(titleFontColor))
                    }
                }
                .menuStyle(BorderlessButtonMenuStyle())
                .help("插入標籤：為日記添加分類標籤，如情緒、活動、思考等，幫助組織和分類日記內容")
                .frame(width: 80)  // 增加按钮宽度以容纳文字
                
                Spacer()
                
                // 添加待办按钮
                Button(action: addTodoItem) {
                    HStack(spacing: 4) {
                        Image(systemName: "checklist.checked")
                            .font(.system(size: 14))
                            .foregroundColor(.white)
                        Text("待辦")
                            .font(.system(size: 12))
                            .foregroundColor(.white)
                    }
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.accentColor)
                    .cornerRadius(6)
                }
                .buttonStyle(PlainButtonStyle())
                .help("添加待辦事項")
            }
            
            TextEditor(text: $thoughts)
                .font(.system(size: contentFontSize))
                .foregroundColor(Color.fromString(contentFontColor))
                .scrollContentBackground(.hidden)
                .padding(.horizontal, 8)
                .padding(.vertical, 8)
                .background(Color(.textBackgroundColor).opacity(0.4))
                .cornerRadius(8)
                .onChange(of: thoughts) { oldValue, newValue in
                    diary.thoughts = newValue
                    saveContext()
                }
        }
        .padding(.vertical, 5)
        .onAppear {
            if thoughts != diary.thoughts {
                thoughts = diary.thoughts
            }
        }
    }
    
    // 格式化预览视图
    @State private var showingFormattedPreview = false
    
    private func showFormattedPreview() {
        showingFormattedPreview = true
    }
    
    public var body: some View {
        VStack(spacing: 5) {
            // 日記頂部信息：只保留日期顯示
            HStack {
                // 日期顯示
                Text(formatDate(diary.date))
                    .font(.system(size: titleFontSize + 3))
                    .foregroundColor(Color.orange)
                    .fontWeight(.bold)
                
                Spacer()
            }
            .padding(.top, 8)
            
            // 使用TabView作為主要內容區域
            TabView(selection: $selectedTab) {
                // 基本頁籤: 包含天氣和記事
                VStack(spacing: 8) {
                    // 天氣信息
                    WeatherSectionView(
                        diary: diary,
                        selectedWeather: $selectedWeather,
                        isOnline: $isOnline,
                        isLoading: $isLoading,
                        weatherService: weatherService,
                        isToday: isToday,
                        titleFontSize: titleFontSize,
                        contentFontSize: contentFontSize,
                        titleFontColor: titleFontColor,
                        switchToManual: switchToManual,
                        saveContext: saveContext
                    )
                    
                    // 文字記事區
                    thoughtsEditor
                        .background(RoundedRectangle(cornerRadius: 8).fill(Color(.textBackgroundColor)).opacity(0.4))
                }
                .padding(.vertical, 8)
                .tag("basic")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "basic", color: .blue) {
                        Label("基本", systemImage: "note.text")
                    }
                }
                
                // 支出頁籤
                ScrollView {
                    CategoryTableView(
                        type: .expense,
                        entries: diary.expenses,
                        diary: diary,
                        onAdd: { showAddSheet(for: .expense) },
                        onDelete: deleteExpenses,
                        onEdit: { editEntrySheet(entry: $0, type: .expense) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("expense")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "expense", color: .green) {
                        Label(DiaryEntryType.expense.localizedName, systemImage: DiaryEntryType.expense.icon)
                    }
                }
                
                // 運動頁籤
                ScrollView {
                    CategoryTableView(
                        type: .exercise,
                        entries: diary.exercises,
                        diary: diary,
                        onAdd: { showAddSheet(for: .exercise) },
                        onDelete: deleteExercises,
                        onEdit: { editEntrySheet(entry: $0, type: .exercise) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("exercise")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "exercise", color: .orange) {
                        Label(DiaryEntryType.exercise.localizedName, systemImage: DiaryEntryType.exercise.icon)
                    }
                }
                
                // 睡眠頁籤
                ScrollView {
                    CategoryTableView(
                        type: .sleep,
                        entries: diary.sleeps,
                        diary: diary,
                        onAdd: { showAddSheet(for: .sleep) },
                        onDelete: deleteSleeps,
                        onEdit: { editEntrySheet(entry: $0, type: .sleep) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("sleep")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "sleep", color: .purple) {
                        Label(DiaryEntryType.sleep.localizedName, systemImage: DiaryEntryType.sleep.icon)
                    }
                }
                
                // 工作頁籤
                ScrollView {
                    CategoryTableView(
                        type: .work,
                        entries: diary.works,
                        diary: diary,
                        onAdd: { showAddSheet(for: .work) },
                        onDelete: deleteWorks,
                        onEdit: { editEntrySheet(entry: $0, type: .work) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("work")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "work", color: .red) {
                        Label(DiaryEntryType.work.localizedName, systemImage: DiaryEntryType.work.icon)
                    }
                }
                
                // 關係頁籤
                ScrollView {
                    CategoryTableView(
                        type: .relationship,
                        entries: diary.relationships,
                        diary: diary,
                        onAdd: { showAddSheet(for: .relationship) },
                        onDelete: deleteRelationships,
                        onEdit: { editEntrySheet(entry: $0, type: .relationship) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("relationship")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "relationship", color: .pink) {
                        Label(DiaryEntryType.relationship.localizedName, systemImage: DiaryEntryType.relationship.icon)
                    }
                }
                
                // 學習頁籤
                ScrollView {
                    CategoryTableView(
                        type: .study,
                        entries: diary.studies,
                        diary: diary,
                        onAdd: { showAddSheet(for: .study) },
                        onDelete: deleteStudies,
                        onEdit: { editEntrySheet(entry: $0, type: .study) }
                    )
                    .padding(.vertical, 8)
                }
                .tag("study")
                .tabItem {
                    CustomTabStyle(isSelected: selectedTab == "study", color: .teal) {
                        Label(DiaryEntryType.study.localizedName, systemImage: DiaryEntryType.study.icon)
                    }
                }
            }
            .onAppear {
                // 默認選擇基本頁籤（天氣與記事）
                if selectedTab == nil {
                    selectedTab = "basic"
                }
            }
        }
        .padding()
        .background(Color(.windowBackgroundColor))
        .sheet(isPresented: $showingSheet) {
            if let editingEntry = editingEntry {
                CategoryEditView(
                    diary: diary,
                    type: currentCategory,
                    editingEntry: editingEntry,
                    isPresented: $showingSheet
                )
                .frame(width: 450, height: 500)
            } else {
                CategoryEditView(
                    diary: diary,
                    type: currentCategory,
                    isPresented: $showingSheet
                )
                .frame(width: 450, height: 500)
            }
        }
        .alert(isPresented: $showingAlert) {
            Alert(title: Text(alertTitle), message: Text(alertMessage), dismissButton: .default(Text("關閉")))
        }
        .sheet(isPresented: $showingFormattedPreview) {
            FormattedPreviewView(diary: diary)
        }
        .onChange(of: diary.thoughts) { oldValue, newValue in
            saveContext()
        }
        .onDisappear {
            saveContext()
        }
    }
    
    // 格式化日期為yyyy/M/d格式
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy/M/d"
        return formatter.string(from: date)
    }
    
    // 保存上下文
    private func saveContext() {
        do {
            try modelContext.save()
        } catch {
            print("Error saving context: \(error)")
        }
    }
    
    // 更新天氣
    private func updateWeather() {
        // 確保有天氣服務
        guard let weatherService = weatherService else { return }
        
        isLoading = true
        
        // 使用天氣服務獲取天氣
        Task {
            do {
                // 獲取當前天氣
                let result = try await weatherService.fetchWeather()
                
                // 在主線程更新UI
                await MainActor.run {
                    // 創建新的天氣記錄
                    let newRecord = WeatherRecord(
                        time: Date(),
                        weather: result.type,
                        temperature: result.temp,
                        location: result.location
                    )
                    
                    // 添加到記錄列表
                    diary.weatherRecords.append(newRecord)
                    
                    // 更新當前狀態
                    diary.weather = result.type
                    diary.temperature = result.temp
                    selectedWeather = result.type.rawValue
                    
                    // 保存更改
                    saveContext()
                    
                    // 完成加載
                    isLoading = false
                    isOnline = true
                }
            } catch {
                // 在主線程處理錯誤
                await MainActor.run {
                    print("獲取天氣時出錯: \(error.localizedDescription)")
                    isLoading = false
                    // 如果自動獲取失敗，切換到手動模式
                    isOnline = false
                }
            }
        }
    }
    
    // 切換到手動模式
    private func switchToManual() {
        isOnline = false
        
        // 如果天氣記錄為空，設置默認天氣
        if diary.weatherRecords.isEmpty {
            // 選擇當前天氣或預設晴天
            let weatherType = WeatherType.allCases.first(where: { $0.rawValue == selectedWeather }) ?? .sunny
            
            // 設置默認天氣
            diary.weather = weatherType
            diary.temperature = diary.temperature.isEmpty ? "25°C" : diary.temperature
            
            saveContext()
        }
    }
    
    // 顯示添加表單
    private func showAddSheet(for type: DiaryEntryType) {
        currentCategory = type
        editingEntry = nil
        showingSheet = true
    }
    
    // 顯示編輯表單
    private func editEntrySheet(entry: CategoryEntry, type: DiaryEntryType) {
        currentCategory = type
        editingEntry = entry
        showingSheet = true
    }
    
    // 刪除支出記錄
    private func deleteExpenses(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.expenses[index])
        }
        diary.expenses.remove(atOffsets: indexSet)
    }
    
    // 刪除運動記錄
    private func deleteExercises(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.exercises[index])
        }
        diary.exercises.remove(atOffsets: indexSet)
    }
    
    // 刪除睡眠記錄
    private func deleteSleeps(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.sleeps[index])
        }
        diary.sleeps.remove(atOffsets: indexSet)
    }
    
    // 刪除工作記錄
    private func deleteWorks(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.works[index])
        }
        diary.works.remove(atOffsets: indexSet)
    }
    
    // 刪除關係記錄
    private func deleteRelationships(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.relationships[index])
        }
        diary.relationships.remove(atOffsets: indexSet)
    }
    
    // 刪除學習記錄
    private func deleteStudies(_ indexSet: IndexSet) {
        for index in indexSet {
            modelContext.delete(diary.studies[index])
        }
        diary.studies.remove(atOffsets: indexSet)
    }
    
    // 修改插入項目符號的方法
    private func insertBulletPoint() {
        // 確保插入的項目符號前沒有數字標記
        thoughts += "\n◎ "
        diary.thoughts = thoughts
        saveContext()
    }
    
    // 修改showReminderDialog方法，确保在这一处显示对话框
    private func showReminderDialog() {
        // 重置表单数据
        reminderTitle = ""
        reminderDate = Date()
        reminderTime = Date()
        selectedRepeatType = .none
        
        // 显示对话框
        showingReminderDialog = true
    }
    
    // 添加提醒
    private func addReminder() {
        // 组合日期和时间
        let reminderDateTime = combineDateTime(date: reminderDate, time: reminderTime)
        
        // 获取重复类型
        let repeatType = selectedRepeatType.rawValue
        
        // 日记文本添加提醒标记
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy/M/d"
        dateFormatter.locale = Locale(identifier: "zh_TW")
        
        let timeFormatter = DateFormatter()
        timeFormatter.dateFormat = "HH:mm"
        timeFormatter.locale = Locale(identifier: "zh_TW")
        
        let repeatText = repeatType == "none" ? "" : " (重复: \(getRepeatTypeDisplayName(repeatType)))"
        let reminderText = "\n⏰ 提醒事項: \(dateFormatter.string(from: reminderDate)) \(timeFormatter.string(from: reminderTime)) \(reminderTitle)\(repeatText)"
        
        // 添加到日记内容
        if !diary.thoughts.isEmpty {
            diary.thoughts += reminderText
        } else {
            diary.thoughts = reminderText
        }
        
        // 创建新的提醒
        let reminder = Reminder(
            title: reminderTitle,
            date: reminderDateTime,
            isCompleted: false,
            repeatType: repeatType
        )
        
        // 保存提醒
        modelContext.insert(reminder)
        
        do {
            // 立即保存到持久存储
            try modelContext.save()
            
            // 发送通知，通知ReminderListView刷新
            NotificationCenter.default.post(name: NSNotification.Name("RefreshReminders"), object: nil)
            
            // 更新界面上的文本
            thoughts = diary.thoughts
            
            // 记录成功添加的日志
            print("成功添加提醒: \(reminderTitle) 于 \(reminderDateTime), 重复类型: \(repeatType)")
        } catch {
            print("保存提醒时出错: \(error.localizedDescription)")
        }
        
        // 重置提醒表单
        reminderTitle = ""
        reminderDate = Date()
        reminderTime = Date()
        showingReminderDialog = false
    }
    
    // 获取重复类型的显示名称
    private func getRepeatTypeDisplayName(_ repeatType: String) -> String {
        switch repeatType {
        case "daily":
            return "每日"
        case "weekly":
            return "每週"
        case "monthly":
            return "每月"
        default:
            return "一次性"
        }
    }
    
    // 添加一个辅助方法来组合日期和时间
    private func combineDateTime(date: Date, time: Date) -> Date {
        let calendar = Calendar.current
        let dateComponents = calendar.dateComponents([.year, .month, .day], from: date)
        let timeComponents = calendar.dateComponents([.hour, .minute], from: time)
        
        var combinedComponents = DateComponents()
        combinedComponents.year = dateComponents.year
        combinedComponents.month = dateComponents.month
        combinedComponents.day = dateComponents.day
        combinedComponents.hour = timeComponents.hour
        combinedComponents.minute = timeComponents.minute
        
        return calendar.date(from: combinedComponents) ?? Date()
    }
    
    // 清理数字前缀函数 - 已不再需要
    private func cleanupNumberedBulletPoints(_ text: String) -> String {
        // 直接返回原文本，不做任何处理
        return text
        
        /*
        let lines = text.split(separator: "\n", omittingEmptySubsequences: false)
        var cleanedLines: [String] = []
        
        for line in lines {
            var lineStr = String(line)
            // 檢查是否符合"數字."+"◎"的模式
            let pattern = #"^(\d+\.)(\s*)◎"#
            if let regex = try? NSRegularExpression(pattern: pattern, options: []) {
                let range = NSRange(location: 0, length: lineStr.utf16.count)
                if let match = regex.firstMatch(in: lineStr, options: [], range: range) {
                    // 替換為只有"◎"
                    if let prefixRange = Range(match.range(at: 1), in: lineStr),
                       let spaceRange = Range(match.range(at: 2), in: lineStr) {
                        lineStr.removeSubrange(prefixRange)
                        // 保留一個空格
                        if spaceRange.isEmpty {
                            lineStr.insert(" ", at: lineStr.startIndex)
                        }
                    }
                }
            }
            cleanedLines.append(lineStr)
        }
        
        return cleanedLines.joined(separator: "\n")
        */
    }
}

// 提醒對話框視圖
struct ReminderDialog: View {
    @Binding var isPresented: Bool
    @Binding var date: Date
    @Binding var time: Date
    @Binding var title: String
    @State private var selectedRepeatType: ReminderRepeatType = .none
    var onConfirm: () -> Void
    
    // 提供一个方法获取当前选择的重复类型
    func getRepeatType() -> String {
        return selectedRepeatType.rawValue
    }
    
    // 使用者偏好設置
    @AppStorage("titleFontSize") private var titleFontSize: Double = 22
    @AppStorage("contentFontSize") private var contentFontSize: Double = 16
    @AppStorage("titleFontColor") private var titleFontColor: String = "Green"
    @AppStorage("contentFontColor") private var contentFontColor: String = "White"
    
    var body: some View {
        NavigationView {
            Form {
                Section {
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Image(systemName: "calendar.badge.exclamationmark")
                                .font(.system(size: titleFontSize * 1.2))
                                .foregroundColor(Color.red)
                            Text("日期")
                                .font(.system(size: titleFontSize))
                                .foregroundColor(Color.fromString(titleFontColor))
                                .fontWeight(.bold)
                                .padding(.bottom, 4)
                        }
                        
                        HStack {
                            Spacer()
                            DatePicker("", selection: $date, displayedComponents: .date)
                                .datePickerStyle(.graphical)
                                .labelsHidden()
                        }
                    }
                }
                
                Section {
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Image(systemName: "clock.badge.exclamationmark")
                                .font(.system(size: titleFontSize * 1.2))
                                .foregroundColor(Color.red)
                            Text("時間")
                                .font(.system(size: titleFontSize))
                                .foregroundColor(Color.fromString(titleFontColor))
                                .fontWeight(.bold)
                                .padding(.bottom, 4)
                        }
                        
                        DatePicker("", selection: $time, displayedComponents: .hourAndMinute)
//                            .datePickerStyle(.wheel)
                            .labelsHidden()
                    }
                }
                
                Section {
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Image(systemName: "bell.badge.fill")
                                .font(.system(size: titleFontSize * 1.2))
                                .foregroundColor(Color.red)
                            Text("提醒事項")
                                .font(.system(size: titleFontSize))
                                .foregroundColor(Color.fromString(titleFontColor))
                                .fontWeight(.bold)
                                .padding(.bottom, 4)
                        }
                        
                        TextField("請輸入提醒事項", text: $title)
                            .font(.system(size: contentFontSize * 1.2))
                            .foregroundColor(Color.fromString(contentFontColor))
                            .textFieldStyle(.roundedBorder)
                            .padding(.horizontal, 4)
                    }
                }
                
                Section {
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Image(systemName: "arrow.clockwise.circle")
                                .font(.system(size: titleFontSize * 1.2))
                                .foregroundColor(Color.blue)
                            Text("重複")
                                .font(.system(size: titleFontSize))
                                .foregroundColor(Color.fromString(titleFontColor))
                                .fontWeight(.bold)
                                .padding(.bottom, 4)
                        }
                        
                        Picker("重複類型", selection: $selectedRepeatType) {
                            Text("不重複").tag(ReminderRepeatType.none)
                            Text("每日").tag(ReminderRepeatType.daily)
                            Text("每週").tag(ReminderRepeatType.weekly)
                            Text("每月").tag(ReminderRepeatType.monthly)
                        }
                        .pickerStyle(.segmented)
                    }
                }
                
                // 提示信息
                if selectedRepeatType != .none {
                    Section {
                        HStack {
                            Image(systemName: "info.circle")
                                .foregroundColor(.blue)
                            Text(getRepeatDescription())
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                    }
                }
            }
            .navigationTitle("新增提醒")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("取消") {
                        isPresented = false
                    }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("確定") {
                        onConfirm()
                    }
                    .disabled(title.isEmpty)
                }
            }
        }
        .frame(width: 400, height: 500)
    }
    
    private func getRepeatDescription() -> String {
        switch selectedRepeatType {
        case .daily:
            return "此提醒將每天觸發一次"
        case .weekly:
            let weekday = Calendar.current.component(.weekday, from: date)
            let weekdaySymbol = Calendar.current.weekdaySymbols[weekday - 1]
            return "此提醒將每週\(weekdaySymbol)觸發一次"
        case .monthly:
            let day = Calendar.current.component(.day, from: date)
            return "此提醒將每月\(day)日觸發一次"
        case .none:
            return "此提醒僅在指定日期觸發一次"
        }
    }
}

// 格式化预览视图
struct FormattedPreviewView: View {
    let diary: DiaryEntry
    
    @Environment(\.dismiss) private var dismiss
    
    var formattedText: AttributedString {
        var result = AttributedString()
        
        // 将文本按行分割
        let lines = diary.thoughts.split(separator: "\n", omittingEmptySubsequences: false)
        
        // 处理每一行
        for (index, line) in lines.enumerated() {
            if !line.isEmpty {
                // 创建行文本，不再检查数字前缀
                var lineString = String(line)
                
                var lineText = AttributedString(lineString)
                
                // 设置整行的基本样式
                lineText.font = .system(size: 16) // Use default size
                lineText.foregroundColor = .primary // Use default color
                
                // 檢查是否有「◎」項目符號
                if let bulletRange = lineText.range(of: "◎") {
                    lineText[bulletRange].font = .system(size: 19) // Slightly larger
                    lineText[bulletRange].foregroundColor = .green // Use a highlight color
                }
                
                // 添加行到结果中
                result.append(lineText)
            }
            
            // 如果不是最后一行，添加换行符
            if index < lines.count - 1 {
                result.append(AttributedString("\n"))
            }
        }
        
        return result
    }
    
    var body: some View {
        VStack {
            HStack {
                Text("美化预览")
                    .font(.headline)
                
                Spacer()
                
                Button("关闭") {
                    dismiss()
                }
                .buttonStyle(.borderless)
            }
            .padding()
            
            ScrollView {
                Text(formattedText)
                    .padding()
                    .frame(maxWidth: .infinity, alignment: .leading)
            }
            .background(Color(.textBackgroundColor).opacity(0.4))
            .cornerRadius(8)
            .padding()
        }
        .frame(width: 500, height: 600)
    }
}

// 分类编辑视图
struct CategoryEditView: View {
    @Environment(\.modelContext) private var modelContext
    @Bindable var diary: DiaryEntry
    let type: DiaryEntryType
    var editingEntry: CategoryEntry?
    @Binding var isPresented: Bool
    
    @State private var name: String = ""
    @State private var number: Double = 0
    @State private var notes: String = ""
    @State private var category: String = ""
    
    // 新增自動完成相關狀態
    @State private var nameSuggestions: [String] = []
    @State private var showingNameSuggestions = false
    @State private var categorySuggestions: [String] = []
    @State private var showingCategorySuggestions = false
    @State private var showingCategoryOptions = false
    @FocusState private var isCategoryFocused: Bool
    @FocusState private var isNameFocused: Bool
    
    // 使用Query獲取所有日記項目用於搜尋歷史資料
    @Query private var allDiaries: [DiaryEntry]
    
    @Environment(\.colorScheme) private var colorScheme
    
    // 使用者偏好設置
    @AppStorage("titleFontSize") private var titleFontSize: Double = 22
    @AppStorage("contentFontSize") private var contentFontSize: Double = 16
    @AppStorage("titleFontColor") private var titleFontColor: String = "Green"
    @AppStorage("contentFontColor") private var contentFontColor: String = "White"
    
    // 根據條目類型獲取名稱標籤
    private var nameLabel: String {
        switch type {
        case .expense: return "名稱"
        case .exercise: return "名稱"
        case .sleep: return "品質"
        case .work: return "名稱"
        case .relationship: return "姓名"
        case .study: return "名稱"
        }
    }
    
    // 根據條目類型獲取類別標籤
    private var categoryLabel: String {
        switch type {
        case .expense: return "類別"
        case .exercise: return "運動類型"
        case .sleep: return "醒來次數"
        case .work: return "工作類型"
        case .relationship: return "關係類型"
        case .study: return "學習類型"
        }
    }
    
    // 根據條目類型獲取數值標籤
    private var numberLabel: String {
        switch type {
        case .expense: return "金額"
        case .exercise: return "時間"
        case .sleep: return "時間"
        case .work: return "時長"
        case .relationship: return "時長"
        case .study: return "時長"
        }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // 标题栏
            titleBar
            
            // 内容表单
            ScrollView {
                VStack(spacing: 20) {
                    // 名称输入区域
                    nameInputSection
                    
                    // 类别选择区域
                    categoryInputSection
                    
                    // 金额输入区域
                    amountInputSection
                    
                    // 备注输入区域
                    notesInputSection
                    
                    Spacer()
                }
                .padding(.vertical)
            }
            
            // 底部按钮区域
            bottomButtonBar
        }
        .frame(width: 450, height: 500)
        .background(colorScheme == .dark ? Color.black.opacity(0.8) : Color.gray.opacity(0.1))
        .onAppear {
            if let entry = editingEntry {
                name = entry.name
                number = entry.number
                notes = entry.notes
                category = entry.category
            } else if !type.categories.isEmpty {
                category = ""
            }
        }
    }
    
    // MARK: - 子视图组件
    
    private var titleBar: some View {
        HStack {
            Text(editingEntry == nil ? "新增\(type.rawValue)記錄" : "編輯\(type.rawValue)記錄")
                .font(.system(size: titleFontSize))
                .foregroundColor(Color.fromString(titleFontColor))
                .fontWeight(.bold)
                .padding()
            
            Spacer()
        }
        .background(Color.black)
    }
    
    private var nameInputSection: some View {
        VStack(alignment: .leading, spacing: 10) {
            // 标题行
            HStack(spacing: 10) {
                CircleIcon(text: "$")
                Text(nameLabel)
                    .foregroundColor(Color.fromString(titleFontColor))
                    .font(.system(size: titleFontSize))
            }
            
            // 输入框
            VStack(alignment: .leading) {
                TextField("", text: $name)
                    .textFieldStyle(PlainTextFieldStyle())
                    .padding(8)
                    .font(.system(size: contentFontSize))
                    .foregroundColor(Color.fromString(contentFontColor))
                    .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                    .cornerRadius(8)
                    .overlay(
                        RoundedRectangle(cornerRadius: 8)
                            .stroke(Color.gray.opacity(0.5), lineWidth: 1)
                    )
                    .focused($isNameFocused)
                    .onChange(of: name) { _, newValue in
                        handleNameChange(newValue)
                    }
                
                // 顯示名稱建議
                if showingNameSuggestions && !nameSuggestions.isEmpty {
                    // 計算合適的高度
                    let maxHeight: CGFloat = 150
                    let itemHeight: CGFloat = 35
                    let calculatedHeight = min(CGFloat(nameSuggestions.count) * itemHeight, maxHeight)
                    
                    ScrollView {
                        VStack(alignment: .leading, spacing: 5) {
                            ForEach(nameSuggestions, id: \.self) { suggestion in
                                Text(suggestion)
                                    .padding(.vertical, 5)
                                    .padding(.horizontal, 10)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color.blue.opacity(0.1))
                                    .cornerRadius(5)
                                    .onTapGesture {
                                        name = suggestion
                                        showingNameSuggestions = false
                                    }
                            }
                        }
                    }
                    .frame(height: calculatedHeight)
                    .background(
                        RoundedRectangle(cornerRadius: 8)
                            .stroke(Color.gray.opacity(0.3), lineWidth: 1)
                    )
                    .transition(.opacity)
                }
            }
        }
        .padding(.horizontal)
    }
    
    private var categoryInputSection: some View {
        VStack(alignment: .leading, spacing: 10) {
            // 标题行
            HStack(spacing: 10) {
                CircleIconImage(systemName: "tag.fill")
                Text(categoryLabel)
                    .foregroundColor(Color.fromString(titleFontColor))
                    .font(.system(size: titleFontSize))
            }
            
            // 輸入框與類別選項
            VStack(alignment: .leading) {
                HStack {
                    TextField("", text: $category)
                        .textFieldStyle(PlainTextFieldStyle())
                        .padding(8)
                        .font(.system(size: contentFontSize))
                        .foregroundColor(Color.fromString(contentFontColor))
                        .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                        .cornerRadius(8)
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(Color.gray.opacity(0.5), lineWidth: 1)
                        )
                        .focused($isCategoryFocused)
                        .onChange(of: category) { _, newValue in
                            handleCategoryChange(newValue)
                        }
                    
                    // 下拉按鈕
                    if !type.categories.isEmpty {
                        Button(action: {
                            showingCategoryOptions.toggle()
                            showingCategorySuggestions = false
                        }) {
                            Image(systemName: showingCategoryOptions ? "chevron.up" : "chevron.down")
                                .foregroundColor(.gray)
                                .padding(8)
                                .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                                .cornerRadius(8)
                        }
                    }
                }
                
                // 顯示類別建議或預設選項
                if showingCategorySuggestions && !categorySuggestions.isEmpty {
                    // 計算合適的高度
                    let maxHeight: CGFloat = 150
                    let itemHeight: CGFloat = 35
                    let calculatedHeight = min(CGFloat(categorySuggestions.count) * itemHeight, maxHeight)
                    
                    ScrollView {
                        VStack(alignment: .leading, spacing: 0) {
                            ForEach(categorySuggestions, id: \.self) { suggestion in
                                Text(suggestion)
                                    .padding(.vertical, 8)
                                    .padding(.horizontal, 10)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(category == suggestion ? Color.blue.opacity(0.1) : Color.clear)
                                    .contentShape(Rectangle())
                                    .onTapGesture {
                                        category = suggestion
                                        showingCategorySuggestions = false
                                    }
                                
                                if suggestion != categorySuggestions.last {
                                    Divider().padding(.horizontal, 5)
                                }
                            }
                        }
                    }
                    .padding(5)
                    .frame(height: calculatedHeight)
                    .background(
                        RoundedRectangle(cornerRadius: 8)
                            .stroke(Color.gray.opacity(0.3), lineWidth: 1)
                    )
                    .transition(.opacity)
                }
                
                if showingCategoryOptions && !type.categories.isEmpty {
                    // 計算合適的高度
                    let maxHeight: CGFloat = 200
                    let itemHeight: CGFloat = 40
                    let calculatedHeight = min(CGFloat(type.categories.count) * itemHeight, maxHeight)
                    
                    ScrollView {
                        VStack(alignment: .leading, spacing: 0) {
                            ForEach(type.categories, id: \.self) { option in
                                VStack(spacing: 0) {
                                    HStack {
                                        Text(option)
                                            .font(.system(size: contentFontSize))
                                        Spacer()
                                        if category == option {
                                            Image(systemName: "checkmark")
                                                .foregroundColor(.blue)
                                        }
                                    }
                                    .contentShape(Rectangle())
                                    .padding(.horizontal, 10)
                                    .padding(.vertical, 8)
                                    .background(category == option ? Color.blue.opacity(0.1) : Color.clear)
                                    .onTapGesture {
                                        category = option
                                        showingCategoryOptions = false
                                    }
                                    
                                    if option != type.categories.last {
                                        Divider().padding(.horizontal, 5)
                                    }
                                }
                            }
                        }
                    }
                    .frame(height: calculatedHeight)
                    .background(
                        RoundedRectangle(cornerRadius: 8)
                            .stroke(Color.gray.opacity(0.3), lineWidth: 1)
                    )
                    .transition(.opacity)
                }
            }
        }
        .padding(.horizontal)
    }
    
    private var amountInputSection: some View {
        VStack(alignment: .leading, spacing: 10) {
            // 标题行
            HStack(spacing: 10) {
                CircleIcon(text: "#")
                Text(numberLabel)
                    .foregroundColor(Color.fromString(titleFontColor))
                    .font(.system(size: titleFontSize))
            }
            
            // 输入区域 - 根据类型显示不同的输入方式
            if type == .expense {
                // 支出金额输入，支持四则运算
                HStack {
                    Spacer()
                    
                    // 使用State变量保存表达式字符串
                    let binding = Binding<String>(
                        get: { 
                            // 如果数值是整数，不显示小数部分
                            if number == Double(Int(number)) {
                                return String(Int(number))
                            }
                            return String(number)
                        },
                        set: { newValue in
                            // 尝试计算四则运算表达式
                            if let result = evaluateMathExpression(newValue) {
                                number = result
                            }
                        }
                    )
                    
                    TextField("輸入金額", text: binding)
                        .textFieldStyle(PlainTextFieldStyle())
                        .multilineTextAlignment(.trailing)
                        .padding(8)
                        .font(.system(size: contentFontSize))
                        .foregroundColor(Color.fromString(contentFontColor))
                        .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                        .cornerRadius(8)
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(Color.gray.opacity(0.5), lineWidth: 1)
                        )
                    
                    // 上下调节按钮
                    AmountStepper(number: $number)
                }
            } else {
                // 时间输入 (h:mm格式)
                HStack {
                    Spacer()
                    
                    // 使用格式化后的时间字符串
                    let timeBinding = Binding<String>(
                        get: { formatMinutesToTimeString(Int(number)) },
                        set: { newValue in
                            // 尝试将h:mm格式转换为分钟
                            let minutes = parseTimeStringToMinutes(newValue)
                            if minutes > 0 {
                                number = Double(minutes)
                            }
                        }
                    )
                    
                    TextField("輸入時間 (例如: 1:30)", text: timeBinding)
                        .textFieldStyle(PlainTextFieldStyle())
                        .multilineTextAlignment(.trailing)
                        .padding(8)
                        .font(.system(size: contentFontSize))
                        .foregroundColor(Color.fromString(contentFontColor))
                        .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                        .cornerRadius(8)
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(Color.gray.opacity(0.5), lineWidth: 1)
                        )
                        .help("請使用小時:分鐘格式，例如 1:30 表示1小時30分鐘")
                    
                    // 上下调节按钮 (调整分钟)
                    VStack(spacing: 2) {
                        Button(action: {
                            number += 1
                        }) {
                            Image(systemName: "chevron.up")
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                        
                        Button(action: {
                            if number > 0 {
                                number -= 1
                            }
                        }) {
                            Image(systemName: "chevron.down")
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                    }
                    .padding(.trailing, 8)
                }
            }
        }
        .padding(.horizontal)
    }
    
    private var notesInputSection: some View {
        VStack(alignment: .leading, spacing: 10) {
            // 标题行
            HStack(spacing: 10) {
                CircleIconImage(systemName: "text.bubble.fill")
                Text("備註")
                    .foregroundColor(Color.fromString(titleFontColor))
                    .font(.system(size: titleFontSize))
            }
            
            // 输入区域
            TextEditor(text: $notes)
                .font(.system(size: contentFontSize))
                .foregroundColor(Color.fromString(contentFontColor))
                .frame(minHeight: 100)
                .padding(4)
                .background(colorScheme == .dark ? Color.black.opacity(0.3) : Color.white)
                .cornerRadius(8)
                .overlay(
                    RoundedRectangle(cornerRadius: 8)
                        .stroke(Color.gray.opacity(0.5), lineWidth: 1)
                )
        }
        .padding(.horizontal)
    }
    
    private var bottomButtonBar: some View {
        HStack {
            Button("取消") {
                isPresented = false
            }
            .frame(width: 150, height: 40)
            .background(Color.gray.opacity(0.3))
            .foregroundColor(.white)
            .cornerRadius(20)
            
            Spacer()
            
            Button("保存") {
                saveEntry()
                isPresented = false
            }
            .frame(width: 150, height: 40)
            .background(Color.blue)
            .foregroundColor(.white)
            .cornerRadius(20)
        }
        .padding()
        .background(Color.black.opacity(0.8))
    }
    
    private func saveEntry() {
        if let entry = editingEntry {
            // 更新现有条目
            entry.name = name
            entry.number = number
            entry.notes = notes
            entry.category = category
        } else {
            // 创建新条目
            let newEntry = CategoryEntry(
                name: name,
                number: number,
                notes: notes,
                category: category,
                type: type,
                date: diary.date
            )
            
            // 根据类型添加到对应的集合
            switch type {
            case .expense:
                diary.expenses.append(newEntry)
            case .exercise:
                diary.exercises.append(newEntry)
            case .sleep:
                diary.sleeps.append(newEntry)
            case .work:
                diary.works.append(newEntry)
            case .relationship:
                diary.relationships.append(newEntry)
            case .study:
                diary.studies.append(newEntry)
            }
            
            // 将新条目插入到数据上下文
            modelContext.insert(newEntry)
        }
        
        // 保存上下文
        do {
            try modelContext.save()
        } catch {
            print("保存分类条目时出错: \(error)")
        }
    }
    
    // MARK: - 自動完成相關功能
    
    // 獲取特定類型的所有歷史條目
    private func getHistoricalEntries() -> [CategoryEntry] {
        var entries: [CategoryEntry] = []
        
        for diary in allDiaries {
            switch type {
            case .expense:
                entries.append(contentsOf: diary.expenses)
            case .exercise:
                entries.append(contentsOf: diary.exercises)
            case .sleep:
                entries.append(contentsOf: diary.sleeps)
            case .work:
                entries.append(contentsOf: diary.works)
            case .relationship:
                entries.append(contentsOf: diary.relationships)
            case .study:
                entries.append(contentsOf: diary.studies)
            }
        }
        
        return entries
    }
    
    // 處理名稱變化
    private func handleNameChange(_ newValue: String) {
        if !newValue.isEmpty {
            // 獲取歷史條目並過濾名稱
            let entries = getHistoricalEntries()
            let uniqueNames = Set(entries.map { $0.name })
            
            // 過濾並排序建議
            nameSuggestions = Array(uniqueNames)
                .filter { $0.localizedCaseInsensitiveContains(newValue) && $0 != newValue }
                .sorted()
            
            showingNameSuggestions = !nameSuggestions.isEmpty
        } else {
            showingNameSuggestions = false
        }
    }
    
    // 處理類別變化
    private func handleCategoryChange(_ newValue: String) {
        if !newValue.isEmpty {
            // 從歷史條目中提取唯一類別
            let entries = getHistoricalEntries()
            let uniqueCategories = Set(entries.map { $0.category })
            
            // 過濾並排序建議
            categorySuggestions = Array(uniqueCategories)
                .filter { $0.localizedCaseInsensitiveContains(newValue) && $0 != newValue }
                .sorted()
            
            showingCategorySuggestions = !categorySuggestions.isEmpty
            showingCategoryOptions = false
        } else {
            showingCategorySuggestions = false
        }
    }
}

// MARK: - 辅助组件

// 数字加减组件
struct AmountStepper: View {
    @Binding var number: Double
    
    var body: some View {
        HStack(spacing: 2) {
            Button(action: {
                number += 1
            }) {
                Image(systemName: "chevron.up")
                    .padding(4)
                    .background(Color.gray.opacity(0.2))
                    .cornerRadius(4)
            }
            
            Button(action: {
                if number > 0 {
                    number -= 1
                }
            }) {
                Image(systemName: "chevron.down")
                    .padding(4)
                    .background(Color.gray.opacity(0.2))
                    .cornerRadius(4)
            }
        }
        .padding(.trailing, 8)
    }
}

// 蓝色圆形图标组件（文字版）
struct CircleIcon: View {
    let text: String
    
    var body: some View {
        ZStack {
            Circle()
                .fill(Color.blue)
                .frame(width: 30, height: 30)
            Text(text)
                .foregroundColor(.white)
                .font(.system(size: 18, weight: .bold))
        }
    }
}

// 蓝色圆形图标组件（图片版）
struct CircleIconImage: View {
    let systemName: String
    
    var body: some View {
        ZStack {
            Circle()
                .fill(Color.blue)
                .frame(width: 30, height: 30)
            Image(systemName: systemName)
                .foregroundColor(.white)
                .font(.system(size: 14))
        }
    }
}

// 在CategoryEditView之后添加以下工具方法

// 格式化分钟为h:mm格式
// This function is already defined in Helpers.swift, removing the duplicate definition

// 解析h:mm格式为分钟
func parseTimeStringToMinutes(_ timeString: String) -> Int {
    // 分割时间字符串
    let components = timeString.split(separator: ":")
    
    // 如果格式不正确，返回0
    guard components.count == 2,
          let hours = Int(components[0]),
          let minutes = Int(components[1]),
          hours >= 0, minutes >= 0, minutes < 60 else {
        return 0
    }
    
    // 转换为总分钟数
    return hours * 60 + minutes
}

// 计算四则运算表达式
func evaluateMathExpression(_ expression: String) -> Double? {
    // 去除所有空格
    let expr = expression.replacingOccurrences(of: " ", with: "")
    
    // 简单的情况：直接是数字
    if let number = Double(expr) {
        return number
    }
    
    // 创建NSExpression来计算四则运算
    do {
        // 检查表达式是否只包含有效字符
        let validChars = CharacterSet(charactersIn: "0123456789.+-*/()").union(.whitespaces)
        guard expr.rangeOfCharacter(from: validChars.inverted) == nil else {
            return nil
        }
        
        let mathExpression = NSExpression(format: expr)
        if let result = mathExpression.expressionValue(with: nil, context: nil) as? Double {
            return result
        }
        return nil
    } catch {
        // 如果计算失败，返回nil
        return nil
    }
}

// MARK: - 自定義時間選擇元件
struct TimePickerView: View {
    @Binding var time: Date
    
    // 使用者偏好設置
    @AppStorage("titleFontSize") private var titleFontSize: Double = 22
    @AppStorage("contentFontSize") private var contentFontSize: Double = 16
    @AppStorage("titleFontColor") private var titleFontColor: String = "Green"
    @AppStorage("contentFontColor") private var contentFontColor: String = "White"
    
    // 時間格式化
    private var timeFormatter: DateFormatter {
        let formatter = DateFormatter()
        formatter.dateFormat = "HH:mm"
        return formatter
    }
    
    var body: some View {
        HStack {
            Text("時間")
                .font(.system(size: titleFontSize))
                .foregroundColor(Color.fromString(titleFontColor))
                .fontWeight(.bold)
            
            Spacer()
            
            HStack(spacing: 15) {
                Text(timeFormatter.string(from: time))
                    .font(.system(size: contentFontSize * 1.2, weight: .bold))
                    .foregroundColor(Color.fromString(contentFontColor))
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.gray.opacity(0.2))
                    .cornerRadius(6)
                
                VStack(spacing: 8) {
                    HStack(spacing: 12) {
                        Button(action: { adjustHour(by: 1) }) {
                            Image(systemName: "chevron.up")
                                .foregroundColor(.blue)
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                        
                        Button(action: { adjustMinute(by: 1) }) {
                            Image(systemName: "chevron.up")
                                .foregroundColor(.blue)
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                    }
                    
                    HStack(spacing: 12) {
                        Button(action: { adjustHour(by: -1) }) {
                            Image(systemName: "chevron.down")
                                .foregroundColor(.blue)
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                        
                        Button(action: { adjustMinute(by: -1) }) {
                            Image(systemName: "chevron.down")
                                .foregroundColor(.blue)
                                .padding(4)
                                .background(Color.gray.opacity(0.2))
                                .cornerRadius(4)
                        }
                    }
                }
            }
        }
    }
    
    // 調整小時
    private func adjustHour(by amount: Int) {
        let calendar = Calendar.current
        time = calendar.date(byAdding: .hour, value: amount, to: time) ?? time
    }
    
    // 調整分鐘
    private func adjustMinute(by amount: Int) {
        let calendar = Calendar.current
        time = calendar.date(byAdding: .minute, value: amount, to: time) ?? time
    }
}

// 在應用啟動時設置全局鼠標追蹤
extension NSApplication {
    // 用於追蹤已經處理過的類
    private static var swizzledClasses = Set<String>()
    
    static func setupTabBarCursor() {
        // 安裝通知觀察器以捕獲標籤欄創建
        NotificationCenter.default.addObserver(
            forName: NSView.frameDidChangeNotification,
            object: nil,
            queue: .main
        ) { notification in
            // 檢查是否是標籤欄視圖
            if let view = notification.object as? NSView,
               view.className.contains("TabBar") || view.className.contains("NSTabViewItem") {
                // 設置鼠標移入移出監聽
                let trackingOptions: NSTrackingArea.Options = [.mouseEnteredAndExited, .activeInKeyWindow]
                
                // 移除現有追蹤區域
                view.trackingAreas.forEach { view.removeTrackingArea($0) }
                
                // 添加新的追蹤區域
                let trackingArea = NSTrackingArea(
                    rect: view.bounds,
                    options: trackingOptions,
                    owner: view,
                    userInfo: nil
                )
                view.addTrackingArea(trackingArea)
                
                // 添加鼠標進入和離開事件
                view.layer?.name = "TabBarItem"
                
                // 嘗試替換標籤欄的默認行為
                swizzleIfNeeded(forClass: type(of: view))
            }
        }
    }
    
    // 方法交換以改變標籤欄的默認光標行為
    private static func swizzleIfNeeded(forClass cls: AnyClass) {
        let className = String(describing: cls)
        
        // 防止重複交換
        guard !swizzledClasses.contains(className),
              className.contains("TabBar") || className.contains("NSTabViewItem") else {
            return
        }
        
        swizzledClasses.insert(className)
        
        // 交換鼠標進入事件處理方法
        if let original = class_getInstanceMethod(cls, #selector(NSView.mouseEntered(with:))),
           let replacement = class_getInstanceMethod(NSView.self, #selector(NSView.cursorToHand)) {
            method_exchangeImplementations(original, replacement)
        }
        
        // 交換鼠標離開事件處理方法
        if let original = class_getInstanceMethod(cls, #selector(NSView.mouseExited(with:))),
           let replacement = class_getInstanceMethod(NSView.self, #selector(NSView.cursorToArrow)) {
            method_exchangeImplementations(original, replacement)
        }
    }
}
